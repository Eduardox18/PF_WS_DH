package servicios;

import gateway.sms.JaxSms;
import java.io.IOException;
import javax.ws.rs.FormParam;
import javax.ws.rs.core.Context;
import javax.ws.rs.core.UriInfo;
import javax.ws.rs.Produces;
import javax.ws.rs.POST;
import javax.ws.rs.Path;
import javax.ws.rs.core.MediaType;
import modelo.dao.ConductorDAO;
import servicios.pojos.Conductor;
import servicios.pojos.Mensaje;
import servicios.pojos.RespuestaEmailSMS;
import java.util.Random;
import modelo.Cifrado;
import modelo.mybatis.MyBatisUtils;
import org.apache.ibatis.session.SqlSession;

@Path("conductor")
public class ConductorWS {

    @Context
    private UriInfo context;

    public ConductorWS() {
    }

    @Path("agregarConductor")
    @POST
    @Produces(MediaType.APPLICATION_JSON)
    public Mensaje agregarUsuario(
            @FormParam("nombre") String nombre,
            @FormParam("apPaterno") String apPaterno,
            @FormParam("apMaterno") String apMaterno,
            @FormParam("fechaNacimiento") String fechaNacimiento,
            @FormParam("noLicencia") String noLicencia,
            @FormParam("telCelular") String telCelular,
            @FormParam("password") String password) {
        Mensaje mensajeRespuesta = new Mensaje();
        Cifrado cifrador = new Cifrado();
        Conductor conductor = new Conductor(nombre, apPaterno, apMaterno, fechaNacimiento,
                noLicencia, telCelular, cifrador.cifrarCadena(password));
        try {
            ConductorDAO.agregarConductor(conductor);
            mensajeRespuesta.setError(false);
            //Envía SMS
            Random rand = new Random();
            
            int number = rand.nextInt(9999) + 1111;
            RespuestaEmailSMS res = new RespuestaEmailSMS();
            JaxSms jax = new JaxSms();
            String respuesta = jax.enviar(telCelular, Integer.toString(number));
            mensajeRespuesta.setSmsCode(respuesta);
            // Fin SMS
            mensajeRespuesta.setMensaje("El usuario se agregó correctamente");
        } catch (IOException ex) {
            ex.printStackTrace();
            mensajeRespuesta.setError(true);
            mensajeRespuesta.setMensaje("Ocurrió un error al registrar el usuario");
        }
        return mensajeRespuesta;
    }
    
    @Path("ingresarApp")
    @POST
    @Produces(MediaType.APPLICATION_JSON)
    public Mensaje ingresarApp(
        @FormParam("telCelular") String telCelular,
        @FormParam("password") String password) {
        Mensaje mensajeRespuesta = new Mensaje();
        Conductor conductor = new Conductor();
        conductor.setTelCelular(telCelular);
        Cifrado cifrado = new Cifrado();
        conductor.setPassword(cifrado.cifrarCadena(password));
        
        boolean exito = false;
        SqlSession conn = null;
        try {
            conn = MyBatisUtils.getSession();
            if (telCelular != null && password != null) {
                exito = ConductorDAO.iniciarSesion(conductor);
                mensajeRespuesta.setMensaje("Inicio exitoso");
                mensajeRespuesta.setError(false);
            }
        } catch (IOException ex) {
            mensajeRespuesta.setMensaje("Error al iniciar");
            mensajeRespuesta.setError(true);
        }
        return mensajeRespuesta;
    }

}
